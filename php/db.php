<?php
    #---------------------------------------------------------------------------------
    # debug settings
    #---------------------------------------------------------------------------------
    if (true) {
        ini_set('display_errors', 1);
        ini_set('display_startup_errors', 1);
        error_reporting(E_ALL);
    }
    #---------------------------------------------------------------------------------
    #
    #---------------------------------------------------------------------------------
    require $_SERVER['DOCUMENT_ROOT'] . '/php/utils.php';
    #---------------------------------------------------------------------------------
    #
    #---------------------------------------------------------------------------------
    !isAuthorized() && die(err2echo(23, '', ''));
    #---------------------------------------------------------------------------------
    #
    #---------------------------------------------------------------------------------
    require $_SERVER['DOCUMENT_ROOT'] . '/php/conn.php';
    #---------------------------------------------------------------------------------
    #
    #---------------------------------------------------------------------------------
    $params = [];
    // echo '0 params is: '. json_encode($params) . ' ';
    #---------------------------------------------------------------------------------
    #
    #---------------------------------------------------------------------------------
    $query = isset($_POST['sql']) ? $_POST['sql'] : '';
    $types = isset($_POST['types']) ? $_POST['types'] : '';
    $param = isset($_POST['param']) ? explode(',', $_POST['param']) : [];
    $wauth = isset($_POST['auth']) ? $_POST['auth'] : 0;
    #
    // echo '0 param is: '. json_encode($param) . ' ';
    // echo '1 auth is: '. $wauth . ' ';
    #---------------------------------------------------------------------------------
    #
    #---------------------------------------------------------------------------------
    if ($wauth) { $types .= 's'; }
    // echo '2 types is: '. $types . ' ';
    #---------------------------------------------------------------------------------
    # with call_user_func_array, array params must be passed by reference
    #---------------------------------------------------------------------------------
    if ($types) { $params[] = & $types; }
    // echo '3 params is: '. json_encode($params) . ' ';
    #---------------------------------------------------------------------------------
    # with call_user_func_array, array params must be passed by reference
    #---------------------------------------------------------------------------------
    $n = count($param);
    // echo '1 n count is: '. $n . ' ';
    for($i = 0; $i < $n; $i++) { $params[] = & $param[$i]; }
    // foreach($param as $value) { $params[] = & $value; }
    #
    $uname = getAuthUserName();
    if ($wauth == true) { $params[] = & $uname; }
    // echo '4 params is: '. json_encode($params) . ' ';
    #---------------------------------------------------------------------------------
    #
    #---------------------------------------------------------------------------------
    !($stmt = $mysqli->prepare($query)) && die();
    !empty($params) && call_user_func_array(array($stmt, 'bind_param'), $params);
    !($stmt->execute()) && die();
    #---------------------------------------------------------------------------------
    #
    #---------------------------------------------------------------------------------
    $rows = [];
    $data = [];
    if ($result = $stmt->get_result()) {
        while($row = $result->fetch_assoc()) { $rows[] = $row; }
        $data['data'] = $rows;
    } else {
        $data['data'] = 'no data';
    }
    $data['insertId'] = mysqli_insert_id($mysqli);
    $data['affectedRows'] = mysqli_affected_rows($mysqli);
    #---------------------------------------------------------------------------------
    #
    #---------------------------------------------------------------------------------
    $stmt->free_result();
    $stmt->close();
    #---------------------------------------------------------------------------------
    #
    #---------------------------------------------------------------------------------
    $mysqli->close();
    #---------------------------------------------------------------------------------
    #
    #---------------------------------------------------------------------------------
    $data['status'] = true;
    echo json_encode($data);
?>