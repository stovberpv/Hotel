<?php

    include 'db-config.php';

    //-------------------------------------------------------------------------------------------------
        // connection to db
    //-------------------------------------------------------------------------------------------------
    $mysqli = mysqli_connect($db_host, $db_user, $db_pass, $db_name);

    if(mysqli_connect_errno()) {
        die("Failed to connect to MySQL: " . mysqli_connect_error());
    }

    //-------------------------------------------------------------------------------------------------
        // get values from ajax
    //-------------------------------------------------------------------------------------------------
    if (isset($_GET["year"])) { 
        $year = $_GET["year"]; 
    } else { 
        die("Year was not set"); 
    };

    if (isset($_GET["month"])) { 
        $month = $_GET["month"]; 
    } else { 
        die("Month was not set");
    };

    //-------------------------------------------------------------------------------------------------
        // setup values
    //-------------------------------------------------------------------------------------------------
    //    $dayin = 01 . "." . $month . "." . $year;
    //    $dayout = cal_days_in_month(CAL_GREGORIAN, $month, $year) . "." . $month . "." . $year;
    $dayin  = $year . "-" . $month . "-" . 01;
    $dayout = $year . "-" . $month . "-" . cal_days_in_month(CAL_GREGORIAN, $month, $year);
    
    //-------------------------------------------------------------------------------------------------
        // prepare queryes
    //-------------------------------------------------------------------------------------------------
    $query = "SELECT * 
                FROM gl001 
                WHERE dayout >= ? 
                  AND dayin  <= ?";

    //-------------------------------------------------------------------------------------------------
        // execute query 1
    //-------------------------------------------------------------------------------------------------
    $stmt = $mysqli->prepare($query);
    $stmt->bind_param('ss', $dayin, $dayout);
    $stmt->execute();
    $result = $stmt->get_result();
    $rows = []; 
    while($row = $result->fetch_assoc()) {
        $rows[] = $row;
    }
    $data['data'] = $rows;
    
    //-------------------------------------------------------------------------------------------------
        // execute query 2
    //-------------------------------------------------------------------------------------------------
    $data['total'] = mysqli_num_rows($result);

    //-------------------------------------------------------------------------------------------------
        // send result
    //-------------------------------------------------------------------------------------------------
    echo json_encode($data);
    
    //-------------------------------------------------------------------------------------------------
        // close connection
    //-------------------------------------------------------------------------------------------------
    $stmt->free_result();
    $stmt->close();

    $mysqli->close();

?>
